[
  {
    "no": "2011",
    "queryPattern": "Q5",
    "name": "Display Aggregate Json",
    "lambda": "prd-coupon-invokeCouponDisplayAggregateJson-function",
    "functionName": "byCouponMasterSql",
    "isMatching": "1",
    "timestamp": "6/26/2023",
    "shortSQL": "_SAME_ FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = 'be6821fa-6ac1-478c-a356-64d24a317a63' ORDER BY l.couponCode, l.couponName, l.createAtMillis, o.resourceId LIMIT 100 OFFSET 0",
    "fullSQL": "SELECT l.couponMasterId, o.resourceId, o.name, l.couponCode, l.couponName, ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'issued' AND l2.couponMasterId = l.couponMasterId ) AS \"発行数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'used' AND l2.couponMasterId = l.couponMasterId ) AS \"使用済数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'canceled' AND l2.couponMasterId = l.couponMasterId ) AS \"キャンセル\", (SELECT COUNT(*) FROM coupon_logs l2 WHERE l2.type = 'displayed' AND l2.couponMasterId = l.couponMasterId)  FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = 'be6821fa-6ac1-478c-a356-64d24a317a63' ORDER BY l.couponCode, l.couponName, l.createAtMillis, o.resourceId LIMIT 100 OFFSET 0",
    "queryAlias": "Q5_1"
  },
  {
    "no": "2271",
    "queryPattern": "Q6",
    "name": "Display Aggregate Csv",
    "lambda": "prd-coupon-invokeCouponDisplayAggregateCsvUrl-function",
    "functionName": "displayedCsvSql",
    "isMatching": "1",
    "timestamp": "8/9/2023",
    "shortSQL": "_SAME_ FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = '2d604e05-5c13-423f-ae98-7f29dc5cc1cf' AND l.couponCode LIKE '%0001%' ORDER BY couponCode, couponName $$) to '_S3_PATH_' iam_role 'arn:aws:iam::856562439801:role/coupon-redshift-cluster-role' HEADER DELIMITER ',' ADDQUOTES PARALLEL OFF",
    "fullSQL": "unload ($$ SELECT ROW_NUMBER() OVER(ORDER BY couponCode, couponName) AS \"No\", o.name AS \"組織名\", couponCode AS \"クーポンコード\", couponName AS \"クーポン名\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'issued' AND l2.couponMasterId = l.couponMasterId ) AS \"発行数\", (SELECT COUNT(*) FROM coupon_logs l2 WHERE l2.type = 'displayed' AND l2.couponMasterId = l.couponMasterId) AS \"参照数\"  FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = '2d604e05-5c13-423f-ae98-7f29dc5cc1cf' AND l.couponCode LIKE '%0001%' ORDER BY couponCode, couponName $$) to 's3://prd-coupon-redshift-bucket-ap-northeast-1-856562439801/ced6e63a-761f-4124-9510-63856d3e3442/' iam_role 'arn:aws:iam::856562439801:role/coupon-redshift-cluster-role' HEADER DELIMITER ',' ADDQUOTES PARALLEL OFF",
    "queryAlias": "Q6_1"
  },
  {
    "no": "2615",
    "queryPattern": "Q7",
    "name": "Usage Aggregate Json byCouponMasterSql",
    "lambda": "prd-coupon-invokeCouponUsageAggregateJson-function",
    "functionName": "byCouponMasterSql",
    "isMatching": "1",
    "timestamp": "6/26/2023",
    "shortSQL": "_SAME_ FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = 'be6821fa-6ac1-478c-a356-64d24a317a63' ORDER BY l.couponCode, l.couponName, l.createAtMillis, o.resourceId LIMIT 20 OFFSET 0",
    "fullSQL": "SELECT l.couponMasterId, o.resourceId, o.name, l.couponCode, l.couponName, ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'issued' AND l2.couponMasterId = l.couponMasterId ) AS \"発行数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'used' AND l2.couponMasterId = l.couponMasterId ) AS \"使用済数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'canceled' AND l2.couponMasterId = l.couponMasterId ) AS \"キャンセル\", (SELECT COUNT(*) FROM coupon_logs l2 WHERE l2.type = 'displayed' AND l2.couponMasterId = l.couponMasterId)  FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = 'be6821fa-6ac1-478c-a356-64d24a317a63' ORDER BY l.couponCode, l.couponName, l.createAtMillis, o.resourceId LIMIT 20 OFFSET 0",
    "queryAlias": "Q7_1"
  },
  {
    "no": "4336",
    "queryPattern": "Q8",
    "name": "Usage Aggregate Json byOrganizationSql",
    "lambda": "prd-coupon-invokeCouponUsageAggregateJson-function",
    "functionName": "byOrganizationSql",
    "isMatching": "1",
    "timestamp": "7/4/2023",
    "shortSQL": "_SAME_ WHERE oc.parentId = 'a998e975-6bfd-40f3-8a64-4e489a6b7cc5' AND o.type = 'SHOP' ORDER BY o.name, o.resourceId LIMIT 100 OFFSET 0",
    "fullSQL": "SELECT o.resourceId AS \"組織ID\", o.name AS \"組織名\", ( SELECT COUNT(*) FROM coupon_logs_filtered l WHERE l.organizationId = o.resourceId AND l.type = 'issued' ) AS \"自拠点発行数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l JOIN organization_closure oc ON oc.parentId = o.resourceId AND l.organizationId = oc.childId WHERE l.type = 'issued' ) AS \"発行数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l WHERE l.organizationId = o.resourceId AND l.type = 'used' ) AS \"自店舗消込数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l, organization_closure oc WHERE oc.parentId = o.resourceId AND oc.childId = l.usedShopId AND l.type = 'used' ) AS \"消込数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l, organization_closure oc WHERE oc.parentId = o.resourceId AND oc.childId = l.usedShopId AND l.type = 'canceled' ) AS \"キャンセル\"  FROM organization o JOIN organization_closure oc ON oc.childId = o.resourceId WHERE oc.parentId = 'a998e975-6bfd-40f3-8a64-4e489a6b7cc5' AND o.type = 'SHOP' ORDER BY o.name, o.resourceId LIMIT 100 OFFSET 0",
    "queryAlias": "Q8_1"
  },
  {
    "no": "5849",
    "queryPattern": "Q9",
    "name": "Usage Aggregate Csv byCouponMasterSql",
    "lambda": "prd-coupon-invokeCouponUsageAggregateCsvUrl-function",
    "functionName": "byCouponMasterCsvSql",
    "isMatching": "1",
    "timestamp": "6/26/2023",
    "shortSQL": "_SAME_ FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = 'be6821fa-6ac1-478c-a356-64d24a317a63' ORDER BY couponCode, couponName $$) to '_S3_PATH_' iam_role 'arn:aws:iam::856562439801:role/coupon-redshift-cluster-role' DELIMITER ',' ADDQUOTES HEADER PARALLEL OFF",
    "fullSQL": "unload ($$ SELECT ROW_NUMBER() OVER(ORDER BY couponCode, couponName) AS \"No\", o.name AS \"組織名\", couponCode AS \"クーポンコード\", couponName AS \"クーポン名\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'issued' AND l2.couponMasterId = l.couponMasterId ) AS \"発行数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'used' AND l2.couponMasterId = l.couponMasterId ) AS \"使用済数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l2 WHERE l2.type = 'canceled' AND l2.couponMasterId = l.couponMasterId ) AS \"キャンセル\"  FROM coupon_logs l JOIN ( SELECT couponMasterId, MAX(createAtMillis) AS createAtMillis FROM coupon_logs GROUP BY couponMasterId ) latest ON l.couponMasterId = latest.couponMasterId AND l.createAtMillis = latest.createAtMillis JOIN organization_closure oc ON oc.childId = l.organizationId JOIN organization o ON o.resourceId = l.organizationId WHERE oc.parentId = 'be6821fa-6ac1-478c-a356-64d24a317a63' ORDER BY couponCode, couponName $$) to 's3://prd-coupon-redshift-bucket-ap-northeast-1-856562439801/4da9b6c6-0239-4900-a4c1-a9031adda551/' iam_role 'arn:aws:iam::856562439801:role/coupon-redshift-cluster-role' DELIMITER ',' ADDQUOTES HEADER PARALLEL OFF",
    "queryAlias": "Q9_1"
  },
  {
    "no": "6322",
    "queryPattern": "Q10",
    "name": "Usage Aggregate Csv byOrganizationCsvSql",
    "lambda": "prd-coupon-invokeCouponUsageAggregateCsvUrl-function",
    "functionName": "byOrganizationCsvSql",
    "isMatching": "1",
    "timestamp": "7/7/2023",
    "shortSQL": "_SAME_ WHERE o.type = 'SHOP' AND oc.parentId = 'a998e975-6bfd-40f3-8a64-4e489a6b7cc5' ORDER BY o.name $$) to '_S3_PATH_' iam_role 'arn:aws:iam::856562439801:role/coupon-redshift-cluster-role' DELIMITER ',' ADDQUOTES HEADER PARALLEL OFF",
    "fullSQL": "unload ($$ SELECT ROW_NUMBER() OVER(ORDER BY o.name) AS \"No\", o.name AS \"組織名\", ( SELECT COUNT(*) FROM coupon_logs_filtered l WHERE l.organizationId = o.resourceId AND l.type = 'issued' ) AS \"発行数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l, organization_closure oc WHERE oc.parentId = o.resourceId AND oc.childId = l.usedShopId AND l.type = 'used' ) AS \"消込数\", ( SELECT COUNT(*) FROM coupon_logs_filtered l, organization_closure oc WHERE oc.parentId = o.resourceId AND oc.childId = l.usedShopId AND l.type = 'canceled' ) AS \"キャンセル\"  FROM organization o JOIN organization_closure oc ON oc.childId = o.resourceId WHERE o.type = 'SHOP' AND oc.parentId = 'a998e975-6bfd-40f3-8a64-4e489a6b7cc5' ORDER BY o.name $$) to 's3://prd-coupon-redshift-bucket-ap-northeast-1-856562439801/7a5aab76-3331-44c1-806a-ce544da6875d/' iam_role 'arn:aws:iam::856562439801:role/coupon-redshift-cluster-role' DELIMITER ',' ADDQUOTES HEADER PARALLEL OFF",
    "queryAlias": "Q10_1"
  }
]